#!/usr/bin/env bash
set -euo pipefail

# Se place dans la racine du projet quel que soit l'endroit d'oÃ¹ le script est lancÃ©
cd "$(dirname "$0")/.." || exit 1
if [[ ! -d backend ]]; then
  # Le script Ã©tait dÃ©jÃ  a la racine
  cd "$(dirname "$0")" || exit 1
fi

if [[ "$(uname)" != "Darwin" ]]; then
  echo "Ce script est destinÃ© Ã  macOS." >&2
  exit 1
fi

error_exit() {
  echo "âŒ $1" >&2
  exit 1
}

echo "ðŸ§¹ [0/5] LibÃ©ration des ports si nÃ©cessaires..."
PORTS_TO_FREE=(3001 5173)

for PORT in "${PORTS_TO_FREE[@]}"; do
  PIDS=$(lsof -ti tcp:"$PORT" 2>/dev/null || true)
  if [[ -z "$PIDS" ]]; then
    echo "âœ… Port $PORT libre"
    continue
  fi

  KILLED=false
  for PID in $PIDS; do
    CMD=$(ps -p "$PID" -o comm= 2>/dev/null | tr -d ' ')
    if [[ "$CMD" == node* || "$CMD" == vite* ]]; then
      kill -9 "$PID" && KILLED=true
    fi
  done

  if $KILLED; then
    echo "ðŸ”´ Port $PORT occupÃ© â†’ terminÃ©"
  else
    echo "âš ï¸ Port $PORT occupÃ© par un processus non Node.js/Vite"
  fi
done

echo "ðŸŸ¢ Tous les ports critiques sont prÃªts."

echo "ðŸ”§ [1/5] Installation des dÃ©pendances..."
pnpm install --frozen-lockfile || error_exit "Impossible d'installer les dÃ©pendances racine."
(cd backend && pnpm install --frozen-lockfile) || error_exit "Impossible d'installer les dÃ©pendances backend."
(cd frontend && pnpm install --frozen-lockfile && pnpm build) || error_exit "Ã‰chec de la compilation du frontend."

echo "âœ… [2/5] Frontend compilÃ© avec succÃ¨s"

# VÃ©rification des permissions d'Ã©criture dans backend
cd "$(dirname "$0")/backend"
echo test > .perm-test || PERM_ERROR=1
rm -f .perm-test
if [[ ${PERM_ERROR:-} ]]; then
  echo "âŒ Permissions insuffisantes dans /backend. Essayez : sudo chown -R $USER ./backend" >&2
  exit 1
fi
cd "$(dirname "$0")"

echo "ðŸš€ [3/5] Lancement des serveurs..."
pnpm dev:all &
SERVERS_PID=$!

# Attente que le port 5173 soit disponible
for i in {1..15}; do
  if nc -z localhost 5173 2>/dev/null; then
    READY=1
    break
  fi
  sleep 1
done

if [[ -z ${READY:-} ]]; then
  kill "$SERVERS_PID"
  error_exit "Le port 5173 n'est pas disponible."
fi

echo "ðŸŒ [4/5] Ouverture de Safari..."
open -a Safari http://localhost:5173 || { kill "$SERVERS_PID"; error_exit "Impossible d'ouvrir Safari."; }

echo "ðŸŽ‰ [5/5] L'application est lancÃ©e !"

trap "kill \"$SERVERS_PID\"" SIGINT
wait "$SERVERS_PID" || echo "âš ï¸  Backend crashed â€” vÃ©rifiez les permissions ou le port 3001" >&2
