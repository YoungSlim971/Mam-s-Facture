#!/usr/bin/env bash
set -e

LOG_DIR="logs"
LOG_FILE="$LOG_DIR/install.log"
mkdir -p "$LOG_DIR"
exec 2>>"$LOG_FILE"

banner() {
  cat <<'BANNER'
 __  __                 _____           _                 
|  \/  |               |  __ \         | |                
| \  / | __ _ _ __ ___ | |__) |__   ___| |_ __ _ _ __ ___ 
| |\/| |/ _` | '_ ` _ \|  ___/ _ \ / __| __/ _` | '__/ _ \
| |  | | (_| | | | | | | |  | (_) | (__| || (_| | | |  __/
|_|  |_|\__,_|_| |_| |_|_|   \___/ \___|\__\__,_|_|  \___|
BANNER
}

banner

if ! command -v pnpm >/dev/null 2>&1; then
  echo "❌ pnpm n'est pas installé. Veuillez l'installer puis réessayer." >&2
  exit 1
fi

echo "📦 Installation des dépendances racine..."
pnpm install > /dev/null

echo "📦 Installation des dépendances backend..."
pnpm --filter ./backend install > /dev/null

echo "📦 Installation des dépendances frontend..."
pnpm --filter ./frontend install > /dev/null

echo "🔨 Compilation du backend..."
pnpm --filter ./backend build > /dev/null

echo "🔨 Construction du frontend..."
pnpm --filter ./frontend run build > /dev/null

echo "🚀 Lancement des serveurs..."
pnpm dev:all &
SERVERS_PID=$!

sleep 3
URL="http://localhost:5173"
case "$(uname)" in
  Darwin)
    open "$URL" &
    ;;
  Linux)
    xdg-open "$URL" &>/dev/null &
    ;;
  MINGW*|MSYS*|CYGWIN*)
    start "$URL" &
    ;;
  *)
    echo "Ouvrez votre navigateur sur $URL"
    ;;
esac

echo "Application disponible sur $URL"

trap "kill \$SERVERS_PID" SIGINT
wait $SERVERS_PID
